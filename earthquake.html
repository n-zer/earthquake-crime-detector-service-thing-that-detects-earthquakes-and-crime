<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<style>
		#mapDiv{
	 		margin:0;
	 		padding: 0;
	 		width: 542px;
	 		height: 300px;
	 		border: 1px solid black;
	 	}
	</style>
	<title>Space Battle</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
	<script>
		'use strict'

		var app = app || {};
		var map;
		var infoWindow;
		var markers = [];

		function externalInit(){
			var mapOptions = {
					center: {lat:39.828127,lng:-98.579404},
					zoom:3
				};
			map = new google.maps.Map(document.getElementById('mapDiv'), mapOptions);
			app.main.init();
		}

		function clearMarkers(){
			if(infoWindow)
				infoWindow.close();
			markers.forEach(function(marker){
				marker.setMap(null);
			});
			markers = [];
		}
		function addMarker(latitude,longitude,title){
	        var position = {lat:Number(latitude),lng:Number(longitude)};
	        var marker = new google.maps.Marker({position:position,map:map});
	        marker.setTitle(title);
	        google.maps.event.addListener(marker,'click',function(e){
	          makeInfoWindow(this.position,this.title);
	        });
	        markers.push(marker);
	      }
	      function makeInfoWindow(position,msg){
	        if(infoWindow) infoWindow.close();
	        infoWindow = new google.maps.InfoWindow({map:map,position:position,content:"<b>"+msg+"</b>"});
	      }

		app.main = {
			map:undefined,
			init:function(){
				console.log('test');
				var mapOptions = {
					center: {lat:39.828127,lng:-98.579404},
					zoom:3
				};
				//map = new google.maps.Map(document.getElementById('mapDiv'), mapOptions);
				var now = Date.now();
				//app.main.makeRequest();
			},
			
			makeRequest:function(){
				$("#reqButton")[0].onclick = undefined;
				document.querySelector("#cumulativeMagnitude").innerHTML = "Working";
				//var lat = Number(document.querySelector("#lat").value);
				//var long = Number(document.querySelector("#long").value);
				//var rad = Number(document.querySelector("#rad").value);
				var bounds = map.getBounds();
				var min = {lat:bounds.getSouthWest().lat(),lng:bounds.getSouthWest().lng()};
				var max = {lat:bounds.getNorthEast().lat(),lng:bounds.getNorthEast().lng()};
				var url = 'proxy.php?filename=http://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&callback=handleData&starttime=2000-01-01&endtime='+(new Date()).toISOString()+'&minlatitude='+min.lat+'&minlongitude='+min.lng+'&maxlatitude='+max.lat+'&maxlongitude='+max.lng;
				url = url.replace(/&/g,'%26');
				/*$.ajax({
					url: 'http://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=2000-01-01&endtime='+(new Date()).toISOString()+'&latitude='+lat+'&longitude='+long+'&maxradiuskm='+rad,
					type:'GET',
					success: handleData
				});*/
				var script = document.createElement('script');
				script.setAttribute('src',url);
				script.setAttribute('id','tempScript');
				document.querySelector('head').appendChild(script);
			}
		};
		function handleData(data){
			$("#cumulativeMagnitude")[0].innerHTML = "done";
			clearMarkers();
			//addMarker(0,0,"test");
			//var cumulativeMagnitude = 0;
			data.features.forEach(function(feature){
				addMarker(feature.geometry.coordinates[1],feature.geometry.coordinates[0],"no title");
			});
			$("#reqButton")[0].onclick = app.main.makeRequest;
		}
		/*window.onload = function(){
			app.main.init();
		}*/
	</script>	
	<script src='https://maps.googleapis.com/maps/api/js?key=AIzaSyDi79ceE9l10cj5sgapDUGQkYgDZe7iZ2s&callback=externalInit' async defer></script>
</head>
<body>
	<p id="cumulativeMagnitude"></p>
	<button id="reqButton" onclick='app.main.makeRequest()'>Make request</button>
	<div id="mapDiv">

	</div>
</body>
</html>
